# 截图功能使用说明

## 概述

项目提供了多种截图方式，包括自动截图和手动截图。截图文件会自动保存到 `screenshots` 文件夹中。

## 自动截图

测试失败时会自动截图，无需手动操作。

## 手动截图

在测试用例中，您可以通过 `driver` fixture 调用截图方法。

### 方法1：错误截图

在测试过程中，如果遇到错误或异常情况，可以手动截图：

```python
import pytest
from pages.desktop_page import DesktopPage

@pytest.mark.teaching
class TestTeachingNavigation:
    @pytest.mark.asyncio
    async def test_example(self, desktop: DesktopPage, driver):
        try:
            # 执行测试步骤
            await driver.page.get_by_text("某个按钮").click()
        except Exception as e:
            # 发生错误时截图
            error_msg = f"点击按钮失败: {str(e)}"
            screenshot_path = await driver.take_error_screenshot(error_msg)
            print(f"错误截图已保存: {screenshot_path}")
            raise
```

### 方法2：成功截图

在关键步骤成功后，可以截图记录：

```python
@pytest.mark.asyncio
async def test_example(self, desktop: DesktopPage, driver):
    # 执行某个重要步骤
    await driver.page.get_by_text("登录").click()
    await asyncio.sleep(1)
    
    # 步骤成功后截图
    screenshot_path = await driver.take_success_screenshot("登录成功")
    print(f"成功截图已保存: {screenshot_path}")
```

### 方法3：通用截图

使用自定义文件名截图：

```python
@pytest.mark.asyncio
async def test_example(self, desktop: DesktopPage, driver):
    # 执行测试步骤
    await driver.page.get_by_text("某个操作").click()
    
    # 使用自定义文件名截图
    screenshot_path = await driver.take_screenshot("关键步骤_操作完成")
    print(f"截图已保存: {screenshot_path}")
```

## 完整的示例

```python
"""
Teaching模块 - 导航功能测试用例
"""
import pytest
import asyncio
from pages.desktop_page import DesktopPage
from playwright.async_api import expect

@pytest.mark.teaching
class TestTeachingNavigation:
    @pytest.mark.asyncio
    async def test_teaching_module_navigation(self, desktop: DesktopPage, driver):
        """测试授课教学模块的完整导航流程"""
        try:
            page = driver.page
            
            # 步骤1: 启动应用
            await expect(page.locator("#app-container")).to_contain_text("实验实践教学平台")
            await page.get_by_text("实验实践教学平台").dblclick()
            await asyncio.sleep(1)
            
            # 截图：应用启动成功
            screenshot_path = await driver.take_success_screenshot("应用启动成功")
            print(f"截图已保存: {screenshot_path}")
            
            # 步骤2: 验证菜单可见
            await expect(page.get_by_role("menuitem", name="统计分析")).to_be_visible()
            
            # 步骤3: 点击某个菜单项
            try:
                await page.get_by_role("menuitem", name="课程库管理").click()
                await asyncio.sleep(1)
                
                # 截图：菜单点击成功
                screenshot_path = await driver.take_success_screenshot("菜单点击成功")
                print(f"截图已保存: {screenshot_path}")
            except Exception as e:
                # 截图：菜单点击失败
                error_msg = f"菜单点击失败: {str(e)}"
                screenshot_path = await driver.take_error_screenshot(error_msg)
                print(f"错误截图已保存: {screenshot_path}")
                raise
            
            # 步骤4: 验证页面元素
            await expect(page.get_by_role("tab", name="个人课程")).to_be_visible()
            
        except Exception as e:
            # 测试失败时自动截图（已在conftest.py中配置）
            raise
```

## 可用的截图方法

### driver.take_error_screenshot(error_message)
- **用途**：错误截图
- **参数**：
  - `error_message` (str): 错误信息，用于生成文件名
- **返回**：截图文件路径（str）
- **示例**：`await driver.take_error_screenshot("登录失败")`

### driver.take_success_screenshot(step_name)
- **用途**：成功截图
- **参数**：
  - `step_name` (str): 步骤名称，用于生成文件名
- **返回**：截图文件路径（str）
- **示例**：`await driver.take_success_screenshot("登录成功")`

### driver.take_screenshot(filename)
- **用途**：通用截图
- **参数**：
  - `filename` (str, 可选): 自定义文件名（不含扩展名）
- **返回**：截图文件路径（str）
- **示例**：`await driver.take_screenshot("关键步骤")`

## 截图文件命名规则

- **错误截图**：`error_YYYYMMDD_HHMMSS_错误信息前20字符.png`
- **成功截图**：`success_YYYYMMDD_HHMMSS_步骤名称前30字符.png`
- **通用截图**：`screenshot_YYYYMMDD_HHMMSS.png` 或自定义文件名

## 注意事项

1. 所有截图都会保存到 `screenshots` 文件夹中
2. 截图文件名中的特殊字符会被自动清理，只保留字母、数字、下划线和连字符
3. 测试失败时会自动截图，无需手动调用 `take_error_screenshot`
4. 截图是异步操作，需要使用 `await` 关键字

## 在pytest-html报告中查看截图

测试失败时，截图会自动添加到 pytest-html 报告中。手动截图不会自动添加到报告中，如果需要，可以：

1. 使用 `pytest_html.extras.png()` 手动添加到报告中（需要导入 `pytest_html`）
2. 或者查看 `screenshots` 文件夹中的截图文件

