# 代码转换工具使用说明

## 📖 简介

代码转换工具是Web控制界面中的一个功能，可以将Playwright录制的同步代码自动转换为项目的异步测试用例格式。

## 🎯 功能特点

- ✅ **自动清理代码** - 移除不需要的浏览器创建代码
- ✅ **同步转异步** - 自动将同步代码转换为异步代码
- ✅ **自动生成测试文件** - 生成符合项目规范的测试用例文件
- ✅ **自动保存** - 一键保存到对应的模块目录

## 🚀 使用步骤

### 第一步：录制代码

使用Playwright Codegen录制操作：

```bash
playwright codegen http://10.70.70.96/Shenyuan_9#/login
```

或者在Web界面点击"启动录制"按钮。

### 第二步：打开代码转换工具

1. 启动Web控制界面：`python run.py`
2. 访问 `http://localhost:8080`
3. 找到"用例录制"面板
4. 点击"代码转换"按钮

### 第三步：转换代码

1. **选择模块** - 选择要保存的模块（授课教学/攻防演练/考试测评）
2. **输入测试名称** - 例如：`login`, `navigation`, `create_course`
3. **粘贴录制的代码** - 将Playwright录制的代码粘贴到输入框
4. **点击"转换"按钮** - 系统会自动转换代码
5. **查看转换结果** - 转换后的代码会显示在结果框中
6. **点击"保存文件"** - 自动保存到对应的模块目录

## 📝 示例

### 输入（录制的代码）

```python
from playwright.sync_api import Playwright, sync_playwright, expect

def run(playwright: Playwright) -> None:
    browser = playwright.chromium.launch(headless=False)
    context = browser.new_context(viewport={"width":1920,"height":1080})
    page = context.new_page()
    page.goto("http://10.70.70.96/Shenyuan_9#/login")
    page.get_by_role("textbox", name="请输入账号").click()
    page.get_by_role("textbox", name="请输入账号").fill("Shenyuan_9")
    page.get_by_role("textbox", name="请输入密码").click()
    page.get_by_role("textbox", name="请输入密码").fill("Shenyuan_9")
    page.get_by_role("button", name="登录").click()
    context.close()
    browser.close()

with sync_playwright() as playwright:
    run(playwright)
```

### 输出（转换后的代码）

```python
"""
授课教学模块 - login测试用例
（由录制代码自动转换生成）

@File  : test_teaching_login.py
@Author: auto
"""
import pytest
from pages.desktop_page import DesktopPage
from playwright.async_api import expect


@pytest.mark.teaching
class TestTeachingLogin:
    """login测试类"""
    
    @pytest.mark.asyncio
    async def test_login(self, desktop: DesktopPage, driver):
        """测试login"""
        try:
            page = driver.page
            
            # ========== 自动转换的录制代码 ==========
            await page.goto("http://10.70.70.96/Shenyuan_9#/login")
            await page.get_by_role("textbox", name="请输入账号").click()
            await page.get_by_role("textbox", name="请输入账号").fill("Shenyuan_9")
            await page.get_by_role("textbox", name="请输入密码").click()
            await page.get_by_role("textbox", name="请输入密码").fill("Shenyuan_9")
            await page.get_by_role("button", name="登录").click()
            
        except Exception as e:
            await driver.reset_to_initial_state()
            raise
```

## 🔧 转换规则

### 1. 自动清理

工具会自动移除以下内容：
- `def run(playwright: Playwright) -> None:`
- `browser = playwright.chromium.launch(...)`
- `context = browser.new_context(...)`
- `page = context.new_page()`
- `context.close()`
- `browser.close()`
- `with sync_playwright() as playwright: ...`

### 2. 同步转异步

自动添加 `await` 关键字：
- `page.goto()` → `await page.goto()`
- `page.click()` → `await page.click()`
- `page.fill()` → `await page.fill()`
- `expect()` → `await expect()`

### 3. 自动生成测试框架

- 自动添加导入语句
- 自动添加pytest标记
- 自动添加测试类和方法
- 自动添加错误处理

## 📁 保存位置

转换后的文件会自动保存到对应的模块目录：

- **授课教学** → `test_cases/teaching/test_teaching_{test_name}.py`
- **攻防演练** → `test_cases/exercise/test_exercise_{test_name}.py`
- **考试测评** → `test_cases/exam/test_exam_{test_name}.py`

## ⚠️ 注意事项

1. **测试名称规范**
   - 使用小写字母和下划线
   - 不要包含空格或特殊字符
   - 示例：`login`, `navigation`, `create_course`

2. **代码完整性**
   - 确保粘贴完整的录制代码
   - 不要手动删除部分代码

3. **模块选择**
   - 根据测试内容选择正确的模块
   - 文件会自动保存到对应目录

4. **转换后检查**
   - 转换后建议检查生成的代码
   - 可能需要手动调整部分内容

## ❓ 常见问题

### Q1: 转换失败怎么办？

**A:** 检查以下几点：
- 确保粘贴的是完整的录制代码
- 确保代码格式正确
- 检查测试名称是否包含特殊字符

### Q2: 转换后的代码需要修改吗？

**A:** 大部分情况下可以直接使用，但可能需要：
- 调整等待时间
- 添加断言验证
- 优化元素定位

### Q3: 可以手动编辑转换后的代码吗？

**A:** 可以！转换后的代码是标准的Python文件，可以随意编辑。

### Q4: 转换工具支持哪些代码格式？

**A:** 目前支持Playwright Codegen生成的同步Python代码。

## 📚 相关资源

- **录制指南**: `录制指南-实习生版.md`
- **详细录制说明**: `录制工具使用说明.md`
- **测试用例说明**: `../test_cases/README.md`

---

**提示**: 代码转换工具可以大大简化测试用例的编写工作，建议优先使用！

