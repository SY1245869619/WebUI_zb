# 高级功能说明

本文档介绍WebUI自动化测试平台的高级功能。

## 📋 功能列表

### 1. ✅ 失败重试机制

**功能说明**：测试用例失败时自动重试，提高测试稳定性。

**配置方式**：
- 已在 `pytest.ini` 中配置：`--reruns=2 --reruns-delay=1`
- 失败用例会自动重试2次，每次重试间隔1秒

**使用说明**：
- 无需额外配置，自动生效
- 可在 `pytest.ini` 中修改重试次数和延迟时间

---

### 2. ✅ 测试环境管理

**功能说明**：支持多环境切换（开发/测试/生产环境）。

**访问方式**：
- WebUI → 左侧"高级功能"面板 → "🌍 环境管理"

**功能特性**：
- 多环境配置管理
- 一键切换环境
- 环境配置包括：Base URL、登录URL、用户名、密码、数据库配置

**配置文件**：`config/settings.yaml`
```yaml
environments:
  dev:
    name: 开发环境
    base_url: http://dev.example.com
    login_url: http://dev.example.com/login
    username: dev_user
    password: dev_pass
  test:
    name: 测试环境
    base_url: http://test.example.com
    login_url: http://test.example.com/login
    username: test_user
    password: test_pass
current_environment: dev
```

---

### 3. ✅ 测试数据管理

**功能说明**：支持CSV/JSON/YAML格式的测试数据，实现数据驱动测试。

**访问方式**：
- WebUI → 左侧"高级功能"面板 → "📊 测试数据"

**功能特性**：
- 数据文件管理（查看、编辑）
- 支持CSV、JSON、YAML格式
- 数据文件存储在 `test_data/` 目录

**使用示例**：
```python
from core.test_data_manager import TestDataManager

data_manager = TestDataManager()
# 加载CSV数据
test_data = data_manager.load_csv('users.csv')
# 在测试用例中使用
for data in test_data:
    # 使用data进行测试
    pass
```

---

### 4. ✅ 测试调度/定时执行

**功能说明**：支持定时执行测试任务（Cron表达式或间隔触发）。

**访问方式**：
- WebUI → 左侧"高级功能"面板 → "📅 测试调度"

**功能特性**：
- 定时任务管理
- 支持Cron表达式（如：每天9点执行）
- 支持间隔触发（如：每2小时执行一次）
- 任务暂停/恢复

**配置示例**（`config/settings.yaml`）：
```yaml
schedules:
  - id: daily_test
    name: 每日回归测试
    enabled: true
    modules: ['teaching', 'exam']
    cron: "0 9 * * *"  # 每天9点执行
  - id: hourly_test
    name: 每小时测试
    enabled: true
    modules: ['exercise']
    interval:
      hours: 2  # 每2小时执行一次
```

---

### 5. ✅ 视频录制

**功能说明**：失败用例自动录制视频，便于问题定位。

**功能特性**：
- 失败用例自动录屏
- 视频保存在 `videos/` 目录
- 通过用例自动删除视频（节省空间）
- 失败用例视频保留，文件名包含 `_FAILED` 标记

**使用说明**：
- 无需配置，自动生效
- 视频格式：WebM
- 视频分辨率：1920x1080

---

### 6. ✅ 性能监控

**功能说明**：收集页面性能指标（加载时间、资源大小等）。

**功能特性**：
- 自动收集页面性能指标
- 指标包括：DOM加载时间、资源加载时间、网络时间等
- 性能数据可导出为JSON

**使用示例**：
```python
from core.performance_monitor import PerformanceMonitor

perf_monitor = PerformanceMonitor()
# 在测试用例中收集指标
metrics = await perf_monitor.collect_metrics(page, 'test_name')
# 导出指标
perf_monitor.export_metrics('performance.json')
```

---

### 7. ✅ 测试结果趋势分析

**功能说明**：存储和分析历史测试结果，生成趋势图表。

**访问方式**：
- WebUI → 左侧"高级功能"面板 → "📈 趋势分析"

**功能特性**：
- 自动保存每次测试结果
- 支持数据库存储（如果配置了MySQL）
- 支持文件存储（JSON格式）
- 趋势数据展示（最近30天）
- 统计信息：总执行次数、平均通过率、平均执行时长等

**数据存储**：
- 数据库表：`test_results`（如果使用数据库）
- 文件存储：`test_results/result_*.json`

---

### 8. ✅ 元素库管理

**功能说明**：集中管理页面元素定位器，便于维护。

**访问方式**：
- WebUI → 左侧"高级功能"面板 → "🎯 元素库"

**功能特性**：
- 按页面组织元素
- 元素选择器集中管理
- 支持导入/导出（JSON格式）
- 元素库文件：`element_library/elements.yaml`

**使用示例**：
```python
from core.element_library import ElementLibrary

element_lib = ElementLibrary()
# 添加元素
element_lib.add_element('login_page', 'username_input', 'input[name="username"]', '用户名输入框')
# 获取元素选择器
selector = element_lib.get_element('login_page', 'username_input')
```

---

### 9. ✅ 测试计划管理

**功能说明**：管理测试用例分组和执行计划。

**访问方式**：
- WebUI → 左侧"高级功能"面板 → "📋 测试计划"

**功能特性**：
- 创建测试计划
- 计划包含：模块列表、测试用例列表、依赖关系
- 支持计划执行命令生成

**使用示例**：
```python
from core.test_plan_manager import TestPlanManager

plan_manager = TestPlanManager()
# 创建测试计划
plan_manager.create_plan(
    plan_id='regression_test',
    name='回归测试计划',
    description='每日回归测试',
    modules=['teaching', 'exam'],
    dependencies=['smoke_test']  # 依赖冒烟测试
)
# 获取执行命令
cmd = plan_manager.get_plan_execution_command('regression_test')
```

---

### 10. ✅ 移动端支持

**功能说明**：支持移动设备模拟，测试移动端页面。

**使用方式**：
- WebUI → 执行控制面板 → 勾选"移动端"复选框

**功能特性**：
- 支持Playwright内置设备模拟（iPhone、Android等）
- 自定义移动端配置（分辨率、User-Agent）
- 配置保存在 `config/settings.yaml`

**配置示例**：
```yaml
playwright:
  device:
    enabled: true
    name: iPhone 12  # 或自定义配置
    # 自定义配置
    width: 375
    height: 667
    user_agent: "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)"
```

---

### 11. ✅ 分布式/并行执行

**功能说明**：支持多进程并行执行测试，提高执行效率。

**使用方式**：
- 通过环境变量 `PYTEST_WORKERS` 设置并行进程数
- 例如：`PYTEST_WORKERS=4 pytest` 使用4个进程并行执行

**功能特性**：
- 基于 `pytest-xdist` 实现
- 自动分配测试用例到不同进程
- 提高大规模测试的执行速度

**注意事项**：
- 并行执行时，每个进程会启动独立的浏览器实例
- 确保系统资源充足（CPU、内存）
- 建议进程数不超过CPU核心数

---

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

新增依赖：
- `pytest-rerunfailures>=12.0` - 失败重试
- `APScheduler>=3.10.0` - 定时调度

### 2. 配置功能

根据需求在 `config/settings.yaml` 中配置相应功能。

### 3. 使用WebUI

启动WebUI后，在左侧"高级功能"面板中可以访问所有高级功能。

---

## 📝 注意事项

1. **数据库存储**：趋势分析功能如果使用数据库存储，需要先配置MySQL连接。
2. **视频录制**：视频文件会占用磁盘空间，建议定期清理。
3. **并行执行**：并行执行时注意资源消耗，避免系统过载。
4. **环境切换**：切换环境后需要重新登录。

---

## 🔧 扩展开发

所有高级功能模块都在 `core/` 目录下，可以按需扩展：

- `core/test_scheduler.py` - 测试调度
- `core/environment_manager.py` - 环境管理
- `core/test_data_manager.py` - 数据管理
- `core/element_library.py` - 元素库
- `core/test_plan_manager.py` - 测试计划
- `core/test_result_analyzer.py` - 趋势分析
- `core/performance_monitor.py` - 性能监控
- `core/video_recorder.py` - 视频录制

---

## 📚 更多信息

- 查看各模块的源代码注释了解详细API
- 参考 `test_cases/` 目录下的测试用例示例
- 查看 `docs/` 目录下的其他文档

