# Playwright Codegen 录制工具使用说明

## 什么是 Playwright Codegen？

Playwright Codegen 是 Playwright 自带的代码生成工具，可以：
- 自动录制你在浏览器中的操作
- 实时生成对应的 Python 代码
- 支持多种定位策略（文本、CSS选择器、XPath等）

## 安装和准备

### 1. 确保已安装 Playwright
```bash
pip install playwright
playwright install
```

### 2. 验证安装
```bash
playwright --version
```

## 使用方法

### 方法一：命令行启动（推荐）

#### 基本用法
```bash
playwright codegen <目标URL>
```

#### 示例
```bash
# 录制登录页面
playwright codegen http://10.70.70.96/Shenyuan_9#/login

# 录制并指定输出文件
playwright codegen http://10.70.70.96/Shenyuan_9#/login --target python-async --output test_cases/teaching/test_recorded.py
```

#### 常用参数
- `--target python-async`: 生成异步Python代码（推荐）
- `--output <文件路径>`: 直接保存到文件
- `--browser chromium`: 指定浏览器（chromium/firefox/webkit）

### 方法二：通过Web控制界面

1. 启动Web控制界面：`python run.py`
2. 访问 `http://localhost:8080`
3. 在"用例录制"面板输入目标URL
4. 点击"启动录制"按钮

## 录制流程

### 步骤1：启动录制
```bash
playwright codegen http://10.70.70.96/Shenyuan_9#/login
```

### 步骤2：执行操作
录制工具会打开两个窗口：
1. **浏览器窗口**：在这里进行实际操作
2. **代码窗口**：实时显示生成的代码

在浏览器中正常操作：
- 输入文本
- 点击按钮
- 选择下拉框
- 滚动页面
- 等等...

### 步骤3：查看生成的代码
代码窗口会实时显示类似这样的代码：
```python
async with page.expect_navigation():
    await page.click("text=登录")
await page.fill("input[name='username']", "Shenyuan_9")
await page.fill("input[name='password']", "Shenyuan_9")
await page.click("button:has-text('登录')")
```

### 步骤4：保存代码
1. 复制生成的代码（Ctrl+A, Ctrl+C）
2. 创建测试文件（如：`test_cases/teaching/test_login.py`）
3. 粘贴代码并保存

## 生成的代码结构

### 基本结构
```python
from playwright.async_api import Playwright, async_playwright, expect

async def run(playwright: Playwright) -> None:
    browser = await playwright.chromium.launch(headless=False)
    context = await browser.new_context()
    page = await context.new_page()
    
    # 你的操作代码
    await page.goto("http://10.70.70.96/Shenyuan_9#/login")
    await page.fill("input[name='username']", "Shenyuan_9")
    # ...
    
    await context.close()
    await browser.close()

async def main():
    async with async_playwright() as playwright:
        await run(playwright)
```

### 整合到项目中的格式
需要将录制的代码整合到项目的测试框架中：

```python
"""
录制的测试用例
"""
import pytest
from pages.desktop_page import DesktopPage
from pages.teaching_app import TeachingApp

@pytest.mark.teaching
class TestTeachingRecorded:
    """授课教学录制测试"""
    
    @pytest.mark.asyncio
    async def test_recorded_operation(self, desktop: DesktopPage, driver):
        """录制的操作步骤"""
        try:
            # 这里粘贴录制的代码
            # 但需要调整：
            # 1. 将 page 改为 driver.page
            # 2. 移除 browser 和 context 的创建代码
            # 3. 添加错误处理
            
            await driver.page.goto("http://10.70.70.96/Shenyuan_9#/login")
            await driver.page.fill("input[name='username']", "Shenyuan_9")
            await driver.page.fill("input[name='password']", "Shenyuan_9")
            await driver.page.click("button:has-text('登录')")
            
        except Exception as e:
            await driver.skip_step(f"操作失败: {e}")
            raise
```

## 代码调整建议

### 1. 使用项目已有的驱动
录制的代码中：
```python
# 原始代码
browser = await playwright.chromium.launch(headless=False)
context = await browser.new_context()
page = await context.new_page()
```

改为使用项目的驱动：
```python
# 使用项目的driver
# driver已经在conftest.py中创建好了
await driver.page.goto(...)
```

### 2. 添加错误处理
```python
try:
    await driver.page.click("button:has-text('登录')")
except Exception as e:
    await driver.skip_step(f"点击登录失败: {e}")
    raise
```

### 3. 使用Page Object模式
如果操作比较复杂，建议封装到Page Object中：
```python
# 在 pages/teaching_app.py 中
async def start_teaching(self):
    await self.driver.click("button:has-text('开始授课')")

# 在测试用例中
await teaching_app.start_teaching()
```

## 保存位置规则

根据测试的应用模块，保存到对应文件夹：

| 应用模块 | 保存位置 |
|---------|---------|
| 授课教学 | `test_cases/teaching/` |
| 攻防演练 | `test_cases/exercise/` |
| 考试测评 | `test_cases/exam/` |

## 文件命名规范

- 以 `test_` 开头
- 使用下划线连接
- 描述测试内容
- 示例：
  - `test_teaching_login.py`
  - `test_exam_create.py`
  - `test_exercise_start.py`

## 高级技巧

### 1. 录制特定浏览器
```bash
playwright codegen --browser firefox http://10.70.70.96/Shenyuan_9#/login
```

### 2. 录制移动端
```bash
playwright codegen --device="iPhone 12" http://10.70.70.96/Shenyuan_9#/login
```

### 3. 设置视口大小
```bash
playwright codegen --viewport-size=1920,1080 http://10.70.70.96/Shenyuan_9#/login
```

### 4. 保存到文件
```bash
playwright codegen --target python-async --output test_cases/teaching/test_new.py http://10.70.70.96/Shenyuan_9#/login
```

## 常见问题

### Q: 录制的代码运行失败？
**A:** 可能的原因：
1. 元素选择器已变化 - 需要更新选择器
2. 页面加载时间不够 - 添加等待
3. 需要登录 - 确保已登录

### Q: 如何定位动态元素？
**A:** Playwright提供了多种定位方式：
- `page.get_by_text("文本")` - 通过文本定位
- `page.get_by_role("button")` - 通过角色定位
- `page.get_by_label("标签")` - 通过标签定位

### Q: 可以录制多个页面吗？
**A:** 可以！录制工具会记录所有页面的操作。

## 最佳实践

1. **录制前先规划**：明确要测试的功能点
2. **操作要完整**：录制完整的业务流程
3. **及时保存**：录制完成后立即保存代码
4. **代码要整理**：将录制的代码整合到项目框架中
5. **添加断言**：验证操作结果是否正确

## 相关资源

- [Playwright官方文档](https://playwright.dev/python/)
- [Playwright Codegen文档](https://playwright.dev/python/docs/codegen)
- 项目README.md

---

**提示**：录制工具生成的代码可能需要根据实际项目进行调整，但基本结构可以直接使用。

